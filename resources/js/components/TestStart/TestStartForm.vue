<template>
  <div class="test-preview" id="math-container">
    <h2 class="text-2xl font-bold mb-6">📘 Bắt đầu làm bài</h2>

    <div v-if="test && test.details && test.details.length">
      <div
        v-for="(detail, index) in test.details"
        :key="detail.id"
        class="mb-6 border-b pb-4"
      >
        <p class="font-semibold mb-2">Câu {{ index + 1 }}:</p>

        <p class="text-lg leading-relaxed" v-html="detail.question.content"></p>

        <!-- Lựa chọn đáp án -->
        <ul v-if="detail.question.answers && detail.question.answers.length" class="mt-3 space-y-1">
          <li v-for="answer in detail.question.answers" :key="answer.id">
            <label>
              <input
                type="radio"
                :name="'q_' + detail.question.id"
                :value="answer.id"
                v-model="answers[detail.question.id]"
                :disabled="isSubmitted"
              />
              <span v-html="answer.content"></span>
            </label>
          </li>
        </ul>
      </div>

      <!-- Nút nộp bài -->
      <div class="text-center mt-6">
        <button
          v-if="!isSubmitted"
          @click="submitTest"
          class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700"
        >
          ✅ Nộp bài
        </button>
      </div>
    </div>

    <div v-else class="text-gray-500">Đang tải đề thi...</div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch, nextTick } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useTestStore } from '@/store/test'
import { renderByMathjax } from 'mathjax-vue3'
import axios from 'axios'
import { useAuthStore } from '@/store/auth'

const route = useRoute()
const router = useRouter()
const store = useTestStore()
const auth = useAuthStore()

const answers = ref({})
const isSubmitted = ref(false)

const test = computed(() => store.selectedTest)
const total = computed(() => test.value?.details?.length || 0)

async function submitTest() {
  if (isSubmitted.value) return
  isSubmitted.value = true

  let correct = 0
  const resultDetails = []
  const answersPayload = []

  // === Tính điểm ===
  for (const detail of test.value.details) {
    const questionId = detail.question.id
    const selectedAnswerId = answers.value[questionId]
    const correctAnswer = detail.question.answers.find(a => a.is_correct == 1)
    const userAnswer = detail.question.answers.find(a => a.id === selectedAnswerId)

    const isCorrect = selectedAnswerId && correctAnswer && selectedAnswerId === correctAnswer.id
    if (isCorrect) correct++

    answersPayload.push({
      question_id: questionId,
      answer_id: selectedAnswerId || null,
      score: isCorrect ? 1 : 0
    })

    if (!isCorrect) {
      resultDetails.push({
        questionContent: detail.question.content,
        correctAnswer: correctAnswer?.content,
        userAnswer: userAnswer?.content || '(Trống)'
      })
    }
  }

  // === Lưu vào DB ===
  try {
    await axios.post('/api/tests/storeUserAnswers', {
      test_id: test.value.id,
      user_id: auth.user.id,
      answers: answersPayload,
    }, {
      headers: { Authorization: `Bearer ${auth.token}` }
    })
  } catch (error) {
    console.error('Lỗi khi lưu đáp án:', error)
  }

  // === Chuyển trang sau khi đã tính điểm ===
  if (auth.user.role === 'Admin') {
    router.push({ name: 'AdminTestResult' })
  } else {
    router.push({
      name: 'TestResult',
      state: {
        score: correct,
        total: test.value.details.length,
        wrongAnswers: resultDetails
      }
    })
  }
}

// === Lấy dữ liệu đề thi khi mount ===
onMounted(async () => {
  const id = route.params.id
  await store.fetchTestDetail(id)

  await nextTick()
  const el = document.getElementById('math-container')
  if (el) renderByMathjax(el)
})

watch(test, async () => {
  await nextTick()
  const el = document.getElementById('math-container')
  if (el) renderByMathjax(el)
})
</script>
